#!/bin/sh
# Stone Henge â€” Pre-push hook
# Enforces docs/AUDIT_TRACKER.md AND docs/SYSTEM_STATE.md are updated
# on fix/* and feat/* branches.
# See Rules 51-52 in docs/stonehenge-dev-rulebook.md

# Skip entirely in Railway CI (no .git directory in build container)
if [ ! -d ".git" ]; then
  exit 0
fi

BRANCH=$(git symbolic-ref HEAD 2>/dev/null | sed 's|refs/heads/||')

if echo "$BRANCH" | grep -qE '^(fix|feat)/'; then

  REMOTE_BRANCH=$(git rev-parse --abbrev-ref --symbolic-full-name @{u} 2>/dev/null)

  if [ -z "$REMOTE_BRANCH" ]; then
    TRACKER_CHANGED=$(git diff main..HEAD --name-only 2>/dev/null | grep -c "AUDIT_TRACKER.md")
    STATE_CHANGED=$(git diff main..HEAD --name-only 2>/dev/null | grep -c "SYSTEM_STATE.md")
  else
    TRACKER_CHANGED=$(git diff "$REMOTE_BRANCH"..HEAD --name-only 2>/dev/null | grep -c "AUDIT_TRACKER.md")
    STATE_CHANGED=$(git diff "$REMOTE_BRANCH"..HEAD --name-only 2>/dev/null | grep -c "SYSTEM_STATE.md")
  fi

  BLOCKED=0

  if [ "$TRACKER_CHANGED" -eq 0 ]; then
    BLOCKED=1
    echo ""
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘  PUSH BLOCKED â€” AUDIT_TRACKER.md not updated                â•‘"
    echo "â•‘  Add resolved entry (âœ…) or new finding (ğŸ”´) then:          â•‘"
    echo "â•‘    git add docs/AUDIT_TRACKER.md                            â•‘"
    echo "â•‘    git commit --amend --no-edit                             â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
  fi

  if [ "$STATE_CHANGED" -eq 0 ]; then
    BLOCKED=1
    echo ""
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘  PUSH BLOCKED â€” SYSTEM_STATE.md not updated                 â•‘"
    echo "â•‘  Update changed schema, routes, functions, or               â•‘"
    echo "â•‘  verified behaviour entries, then:                          â•‘"
    echo "â•‘    git add docs/SYSTEM_STATE.md                             â•‘"
    echo "â•‘    git commit --amend --no-edit                             â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
  fi

  if [ "$BLOCKED" -eq 1 ]; then
    echo ""
    exit 1
  fi
fi

# Print open audit items after every successful push
echo ""
echo "ğŸ“‹ AUDIT TRACKER â€” Open Issues:"
grep "ğŸ”´" docs/AUDIT_TRACKER.md || echo "   âœ… None â€” all clear"
echo ""

exit 0
