#!/bin/sh
# Stone Henge â€” Pre-push hook
# Enforces AUDIT_TRACKER.md is updated on fix/* and feat/* branches

BRANCH=$(git symbolic-ref HEAD 2>/dev/null | sed 's|refs/heads/||')

# Only enforce on fix/ and feat/ branches
if echo "$BRANCH" | grep -qE '^(fix|feat)/'; then
  # Get commits being pushed (new commits not yet on remote)
  REMOTE="origin"
  REMOTE_BRANCH=$(git rev-parse --abbrev-ref --symbolic-full-name @{u} 2>/dev/null)

  if [ -z "$REMOTE_BRANCH" ]; then
    # No upstream set yet â€” check all commits on this branch vs main
    COMMITS=$(git log main..HEAD --oneline 2>/dev/null)
  else
    COMMITS=$(git log "$REMOTE_BRANCH"..HEAD --oneline 2>/dev/null)
  fi

  if [ -z "$COMMITS" ]; then
    # Nothing new to push
    exit 0
  fi

  # Check if AUDIT_TRACKER.md was touched in the commits being pushed
  if [ -z "$REMOTE_BRANCH" ]; then
    TRACKER_CHANGED=$(git diff main..HEAD --name-only 2>/dev/null | grep -c "AUDIT_TRACKER.md")
  else
    TRACKER_CHANGED=$(git diff "$REMOTE_BRANCH"..HEAD --name-only 2>/dev/null | grep -c "AUDIT_TRACKER.md")
  fi

  if [ "$TRACKER_CHANGED" -eq 0 ]; then
    echo ""
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘  PUSH BLOCKED â€” AUDIT_TRACKER.md not updated                â•‘"
    echo "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£"
    echo "â•‘  Branch: $BRANCH"
    echo "â•‘                                                              â•‘"
    echo "â•‘  Every fix/* and feat/* branch MUST update                  â•‘"
    echo "â•‘  docs/AUDIT_TRACKER.md before pushing.                      â•‘"
    echo "â•‘                                                              â•‘"
    echo "â•‘  Add a resolved entry (âœ…) or new finding (ğŸ”´) then:        â•‘"
    echo "â•‘    git add docs/AUDIT_TRACKER.md                            â•‘"
    echo "â•‘    git commit --amend --no-edit                             â•‘"
    echo "â•‘    git push                                                  â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo ""
    exit 1
  fi
fi

exit 0
