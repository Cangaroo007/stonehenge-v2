generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model audit_logs {
  id          Int      @id @default(autoincrement())
  user_id     Int?
  action      String
  entity_type String
  entity_id   String
  changes     Json?
  ip_address  String?
  user_agent  String?
  created_at  DateTime @default(now())
  user        user?    @relation(fields: [user_id], references: [id])

  @@index([created_at])
  @@index([entity_type, entity_id])
  @@index([user_id])
}

/// This model or at least one of its fields has comments in the database, and requires an additional setup for migrations: Read more: https://pris.ly/d/database-comments
model client_tiers {
  id                   String                 @id
  name                 String                 @unique
  description          String?
  priority             Int                    @default(0)
  isDefault            Boolean                @default(false)
  isActive             Boolean                @default(true)
  sortOrder            Int                    @default(0)
  createdAt            DateTime               @default(now())
  updatedAt            DateTime
  discount_matrix      Json?
  custom_price_list    Json?
  customers            customers[]
  pricing_rules_engine pricing_rules_engine[]
}

model client_types {
  id                   String                 @id
  name                 String                 @unique
  description          String?
  isActive             Boolean                @default(true)
  sortOrder            Int                    @default(0)
  createdAt            DateTime               @default(now())
  updatedAt            DateTime
  customers            customers[]
  pricing_rules_engine pricing_rules_engine[]
}

model companies {
  id                  Int       @id @default(autoincrement())
  name                String
  created_at          DateTime? @default(now()) @db.Timestamp(6)
  updated_at          DateTime? @default(now()) @db.Timestamp(6)
  website             String?
  logo_storage_key    String?
  primary_color       String?   @default("#1e40af")
  quote_intro_text_1  String?
  quote_intro_text_2  String?
  quote_intro_text_3  String?
  quote_please_note   String?
  quote_terms_text_1  String?
  quote_terms_text_2  String?
  quote_terms_text_3  String?
  quote_terms_text_4  String?
  quote_validity_days Int?      @default(30)
  deposit_percent     Int?      @default(50)
  terms_url           String?
  signature_name      String?
  signature_title     String?
  default_unit_system String?   @default("METRIC")
  user                user[]
  suppliers           suppliers[]
  quoteTemplates      quote_templates[]
  quotes              quotes[]
  customers           customers[]
  materials           materials[]
  unitBlockProjects   unit_block_projects[]
  customRoomPresets   custom_room_presets[]
}

model customers {
  id                    Int                    @id @default(autoincrement())
  name                  String
  company               String?
  email                 String?
  phone                 String?
  address               String?
  notes                 String?
  created_at            DateTime               @default(now())
  updated_at            DateTime
  client_tier_id        String?
  client_type_id        String?
  default_price_book_id String?
  company_id            Int
  tenant                companies              @relation(fields: [company_id], references: [id])
  client_tiers          client_tiers?          @relation(fields: [client_tier_id], references: [id])
  client_types          client_types?          @relation(fields: [client_type_id], references: [id])
  price_books           price_books?           @relation(fields: [default_price_book_id], references: [id])
  drawings              drawings[]
  pricing_rules_engine  pricing_rules_engine[]
  quotes                quotes[]
  user                  user[]
  unitBlockProjects     unit_block_projects[]
  contacts              customer_contacts[]
  locations             customer_locations[]

  @@index([company_id])
}

model customer_contacts {
  id                Int         @id @default(autoincrement())
  customer_id       Int
  first_name        String
  last_name         String
  email             String?
  phone             String?
  mobile            String?
  role              ContactRole @default(PRIMARY)
  role_title        String?
  is_primary        Boolean     @default(false)
  notes             String?

  has_portal_access Boolean     @default(false)
  portal_user_id    Int?        @unique

  created_at        DateTime    @default(now())
  updated_at        DateTime    @updatedAt

  customer          customers   @relation(fields: [customer_id], references: [id], onDelete: Cascade)
  portal_user       user?       @relation("ContactPortalUser", fields: [portal_user_id], references: [id])
  quotes            quotes[]    @relation("QuoteContact")

  @@index([customer_id])
  @@map("customer_contacts")
}

model customer_locations {
  id            Int      @id @default(autoincrement())
  customer_id   Int
  label         String?
  address_line1 String
  address_line2 String?
  suburb        String
  state         String
  postcode      String
  country       String   @default("Australia")
  is_default    Boolean  @default(false)
  notes         String?

  created_at    DateTime @default(now())
  updated_at    DateTime @updatedAt

  customer      customers @relation(fields: [customer_id], references: [id], onDelete: Cascade)

  @@index([customer_id])
  @@map("customer_locations")
}

model cutout_rates {
  id                  String             @id
  pricing_settings_id String
  cutout_type         CutoutRateCategory
  name                String
  description         String?
  rate                Decimal            @db.Decimal(10, 2)
  isActive            Boolean            @default(true)
  created_at          DateTime           @default(now())
  updated_at          DateTime
  pricing_settings    pricing_settings   @relation(fields: [pricing_settings_id], references: [id], onDelete: Cascade)

  @@unique([pricing_settings_id, cutout_type])
}

model cutout_types {
  id                   String                      @id
  name                 String                      @unique
  description          String?
  baseRate             Decimal                     @db.Decimal(10, 2)
  isActive             Boolean                     @default(true)
  sortOrder            Int                         @default(0)
  createdAt            DateTime                    @default(now())
  updatedAt            DateTime
  pricing_rule_cutouts pricing_rule_cutouts[]
  categoryRates        cutout_category_rates[]
}

model cutout_category_rates {
  id                  Int                 @id @default(autoincrement())
  cutoutTypeId        String              @map("cutout_type_id")
  cutoutType          cutout_types        @relation(fields: [cutoutTypeId], references: [id], onDelete: Cascade)
  fabricationCategory FabricationCategory @map("fabrication_category")
  rate                Decimal             @default(0) @db.Decimal(10, 2)
  pricingSettingsId   String              @map("pricing_settings_id")
  pricingSettings     pricing_settings    @relation(fields: [pricingSettingsId], references: [id])

  @@unique([cutoutTypeId, fabricationCategory, pricingSettingsId])
  @@map("cutout_category_rates")
}

model edge_type_category_rates {
  id                  Int                 @id @default(autoincrement())
  edgeTypeId          String              @map("edge_type_id")
  edgeType            edge_types          @relation(fields: [edgeTypeId], references: [id], onDelete: Cascade)
  fabricationCategory FabricationCategory @map("fabrication_category")
  rate20mm            Decimal             @default(0) @db.Decimal(10, 2)
  rate40mm            Decimal             @default(0) @db.Decimal(10, 2)
  pricingSettingsId   String              @map("pricing_settings_id")
  pricingSettings     pricing_settings    @relation(fields: [pricingSettingsId], references: [id])

  @@unique([edgeTypeId, fabricationCategory, pricingSettingsId])
  @@map("edge_type_category_rates")
}

model material_edge_compatibility {
  id                  Int                 @id @default(autoincrement())
  fabricationCategory FabricationCategory @map("fabrication_category")
  edgeTypeId          String              @map("edge_type_id")
  edgeType            edge_types          @relation("EdgeCompatibility", fields: [edgeTypeId], references: [id], onDelete: Cascade)
  isAllowed           Boolean             @default(true) @map("is_allowed")
  warningMessage      String?             @map("warning_message")
  pricingSettingsId   String              @map("pricing_settings_id")
  pricingSettings     pricing_settings    @relation(fields: [pricingSettingsId], references: [id])

  @@unique([fabricationCategory, edgeTypeId, pricingSettingsId])
  @@map("material_edge_compatibility")
}

model drawings {
  id           String    @id
  filename     String
  storageKey   String
  mimeType     String
  fileSize     Int
  uploadedAt   DateTime  @default(now())
  quoteId      Int
  customerId   Int
  analysisData Json?
  isPrimary    Boolean   @default(false)
  notes        String?
  thumbnailKey String?
  customers    customers @relation(fields: [customerId], references: [id], onDelete: Cascade)
  quotes       quotes    @relation(fields: [quoteId], references: [id], onDelete: Cascade)

  @@index([customerId])
  @@index([quoteId])
}

model edge_types {
  id                 String               @id
  name               String               @unique
  description        String?
  category           String               @default("polish")
  baseRate           Decimal              @db.Decimal(10, 2)
  isActive           Boolean              @default(true)
  sortOrder          Int                  @default(0)
  createdAt          DateTime             @default(now())
  updatedAt          DateTime
  code               String?              @unique
  rate20mm           Decimal?             @db.Decimal(10, 2)
  rate40mm           Decimal?             @db.Decimal(10, 2)
  minimumCharge      Decimal?             @db.Decimal(10, 2)
  minimumLength      Decimal?             @db.Decimal(10, 2)
  isCurved           Boolean              @default(false)
  pricing_rule_edges pricing_rule_edges[]
  categoryRates      edge_type_category_rates[]
  compatibility      material_edge_compatibility[] @relation("EdgeCompatibility")
}

model machine_profiles {
  id                         String                       @id
  name                       String                       @unique
  kerf_width_mm              Int                          @default(8)
  max_slab_length_mm         Int?
  max_slab_width_mm          Int?
  is_default                 Boolean                      @default(false)
  is_active                  Boolean                      @default(true)
  created_at                 DateTime                     @default(now())
  updated_at                 DateTime
  machine_operation_defaults machine_operation_defaults[]
}

model machine_operation_defaults {
  id             String           @id @default(cuid())
  operation_type OperationType    @unique
  machine_id     String
  machine        machine_profiles @relation(fields: [machine_id], references: [id])
  is_default     Boolean          @default(true)
  created_at     DateTime         @default(now())
  updated_at     DateTime         @updatedAt
}

model materials {
  id                     Int                      @id @default(autoincrement())
  name                   String
  collection             String?
  description            String?
  price_per_sqm          Decimal                  @db.Decimal(10, 2)
  is_active              Boolean                  @default(true)
  created_at             DateTime                 @default(now())
  updated_at             DateTime
  price_per_slab         Decimal?                 @db.Decimal(10, 2)
  price_per_square_metre Decimal?                 @db.Decimal(10, 2)
  slab_length_mm         Int?
  slab_width_mm          Int?
  fabrication_category   FabricationCategory      @default(ENGINEERED)

  // Tenant isolation
  company_id             Int
  tenant                 companies                @relation(fields: [company_id], references: [id])

  // Supplier link
  supplier_id            String?
  supplier               suppliers?               @relation(fields: [supplier_id], references: [id])

  // Pricing — wholesale is supplier's list price; price_per_slab serves as cost price
  wholesale_price        Decimal?                 @db.Decimal(10, 2)

  // Product identification
  product_code           String?
  supplier_range         String?
  surface_finish         String?

  // Margin override (null = use supplier default)
  margin_override_percent Decimal?                @db.Decimal(5, 2)

  // Discontinuation tracking
  is_discontinued        Boolean                  @default(false)
  discontinued_at        DateTime?

  pricing_rule_materials pricing_rule_materials[]
  quote_pieces           quote_pieces[]

  @@index([company_id])
}

model piece_features {
  id              Int            @id @default(autoincrement())
  piece_id        Int
  pricing_rule_id Int?
  name            String
  quantity        Int            @default(1)
  unit_price      Decimal        @db.Decimal(10, 2)
  total_price     Decimal        @db.Decimal(10, 2)
  quote_pieces    quote_pieces   @relation(fields: [piece_id], references: [id], onDelete: Cascade)
  pricing_rules   pricing_rules? @relation(fields: [pricing_rule_id], references: [id])
}

model price_book_rules {
  id                   String               @id
  price_book_id        String
  pricing_rule_id      String
  sortOrder            Int                  @default(0)
  price_books          price_books          @relation(fields: [price_book_id], references: [id], onDelete: Cascade)
  pricing_rules_engine pricing_rules_engine @relation(fields: [pricing_rule_id], references: [id], onDelete: Cascade)

  @@unique([price_book_id, pricing_rule_id])
}

model price_books {
  id               String             @id
  name             String             @unique
  description      String?
  category         String             @default("general")
  defaultThickness Int                @default(20)
  isActive         Boolean            @default(true)
  isDefault        Boolean            @default(false)
  sortOrder        Int                @default(0)
  createdAt        DateTime           @default(now())
  updatedAt        DateTime
  customers        customers[]
  price_book_rules price_book_rules[]
  quotes           quotes[]
}

model pricing_rule_cutouts {
  id                   String               @id
  pricingRuleId        String
  cutoutTypeId         String
  customRate           Decimal?             @db.Decimal(10, 2)
  adjustmentType       String?
  adjustmentValue      Decimal?             @db.Decimal(10, 4)
  cutout_types         cutout_types         @relation(fields: [cutoutTypeId], references: [id])
  pricing_rules_engine pricing_rules_engine @relation(fields: [pricingRuleId], references: [id], onDelete: Cascade)

  @@unique([pricingRuleId, cutoutTypeId])
}

model pricing_rule_edges {
  id                   String               @id
  pricingRuleId        String
  edgeTypeId           String
  customRate           Decimal?             @db.Decimal(10, 2)
  adjustmentType       String?
  adjustmentValue      Decimal?             @db.Decimal(10, 4)
  edge_types           edge_types           @relation(fields: [edgeTypeId], references: [id])
  pricing_rules_engine pricing_rules_engine @relation(fields: [pricingRuleId], references: [id], onDelete: Cascade)

  @@unique([pricingRuleId, edgeTypeId])
}

model pricing_rule_materials {
  id                   String               @id
  pricingRuleId        String
  materialId           Int
  customRate           Decimal?             @db.Decimal(10, 2)
  adjustmentType       String?
  adjustmentValue      Decimal?             @db.Decimal(10, 4)
  materials            materials            @relation(fields: [materialId], references: [id])
  pricing_rules_engine pricing_rules_engine @relation(fields: [pricingRuleId], references: [id], onDelete: Cascade)

  @@unique([pricingRuleId, materialId])
}

model pricing_rules {
  id             Int              @id @default(autoincrement())
  category       String
  name           String
  description    String?
  price          Decimal          @db.Decimal(10, 2)
  price_type     String
  is_active      Boolean          @default(true)
  created_at     DateTime         @default(now())
  updated_at     DateTime
  piece_features piece_features[]
}

model pricing_rules_engine {
  id                     String                   @id
  name                   String
  description            String?
  priority               Int                      @default(0)
  clientTypeId           String?
  clientTierId           String?
  customerId             Int?
  minQuoteValue          Decimal?                 @db.Decimal(10, 2)
  maxQuoteValue          Decimal?                 @db.Decimal(10, 2)
  thicknessValue         Int?
  adjustmentType         String
  adjustmentValue        Decimal                  @db.Decimal(10, 4)
  appliesTo              String
  isActive               Boolean                  @default(true)
  createdAt              DateTime                 @default(now())
  updatedAt              DateTime
  price_book_rules       price_book_rules[]
  pricing_rule_cutouts   pricing_rule_cutouts[]
  pricing_rule_edges     pricing_rule_edges[]
  pricing_rule_materials pricing_rule_materials[]
  client_tiers           client_tiers?            @relation(fields: [clientTierId], references: [id])
  client_types           client_types?            @relation(fields: [clientTypeId], references: [id])
  customers              customers?               @relation(fields: [customerId], references: [id])
}

model pricing_settings {
  id                               String                 @id
  organisation_id                  String                 @unique
  material_pricing_basis           MaterialPricingBasis   @default(PER_SLAB)
  cutting_unit                     ServiceUnit            @default(LINEAR_METRE)
  polishing_unit                   ServiceUnit            @default(LINEAR_METRE)
  installation_unit                ServiceUnit            @default(SQUARE_METRE)
  unit_system                      UnitSystem             @default(METRIC)
  currency                         String                 @default("AUD")
  gst_rate                         Decimal                @default(0.10) @db.Decimal(5, 4)
  laminated_multiplier             Decimal                @default(1.30) @db.Decimal(5, 2)
  mitred_multiplier                Decimal                @default(1.50) @db.Decimal(5, 2)
  waste_factor_percent             Decimal                @default(15.0) @db.Decimal(5, 2)
  grain_matching_surcharge_percent Decimal                @default(15.0) @db.Decimal(5, 2)
  cutout_thickness_multiplier      Decimal                @default(1.0) @db.Decimal(5, 2)
  waterfall_pricing_method         WaterfallPricingMethod @default(FIXED_PER_END)
  slab_edge_allowance_mm           Int?
  created_at                       DateTime               @default(now())
  updated_at                       DateTime
  cutout_rates                     cutout_rates[]
  cutoutCategoryRates              cutout_category_rates[]
  edgeCategoryRates                edge_type_category_rates[]
  edgeCompatibility                material_edge_compatibility[]
  service_rates                    service_rates[]
}

model quote_drawing_analyses {
  id              Int      @id @default(autoincrement())
  quote_id        Int      @unique
  filename        String
  analyzed_at     DateTime @default(now())
  drawing_type    String
  raw_results     Json
  metadata        Json?
  imported_pieces String[]
  quotes          quotes   @relation(fields: [quote_id], references: [id], onDelete: Cascade)
}

model quote_files {
  id            Int      @id @default(autoincrement())
  quote_id      Int
  filename      String
  original_name String
  file_path     String
  file_type     String?
  file_size     Int?
  uploaded_at   DateTime @default(now())
  analysis_json Json?
  quotes        quotes   @relation(fields: [quote_id], references: [id], onDelete: Cascade)
}

model quote_pieces {
  id                Int              @id @default(autoincrement())
  room_id           Int
  material_id       Int?
  material_name     String?
  description       String?
  length_mm         Int
  width_mm          Int
  thickness_mm      Int
  area_sqm          Decimal          @db.Decimal(10, 4)
  material_cost     Decimal          @default(0) @db.Decimal(10, 2)
  features_cost     Decimal          @default(0) @db.Decimal(10, 2)
  total_cost        Decimal          @default(0) @db.Decimal(10, 2)
  sort_order        Int              @default(0)
  cutouts           Json             @default("[]")
  edge_bottom       String?
  edge_left         String?
  edge_right        String?
  edge_top          String?
  name              String           @default("Piece")
  lamination_method LaminationMethod @default(NONE)
  isOversize        Boolean          @default(false)
  joinCount         Int              @default(0)
  joinLengthMm      Int?
  waterfall_height_mm Int?
  piece_features      piece_features[]
  materials           materials?           @relation(fields: [material_id], references: [id])
  quote_rooms         quote_rooms          @relation(fields: [room_id], references: [id], onDelete: Cascade)
  sourceRelationships piece_relationships[] @relation("source_relationships")
  targetRelationships piece_relationships[] @relation("target_relationships")
}

model quote_rooms {
  id           Int            @id @default(autoincrement())
  quote_id     Int
  name         String
  sort_order   Int            @default(0)
  notes        String?
  quote_pieces quote_pieces[]
  quotes       quotes         @relation(fields: [quote_id], references: [id], onDelete: Cascade)
}

model quote_signatures {
  id               Int      @id @default(autoincrement())
  quote_id         Int      @unique
  signer_name      String
  signer_email     String
  signer_title     String?
  user_id          Int?
  signature_type   String
  signature_data   String
  signed_at        DateTime @default(now())
  ip_address       String
  user_agent       String
  document_hash    String
  document_version String
  signed_pdf_path  String?
  quotes           quotes   @relation(fields: [quote_id], references: [id], onDelete: Cascade)
  user             user?    @relation(fields: [user_id], references: [id])
}

model quote_views {
  id         Int      @id @default(autoincrement())
  quote_id   Int
  user_id    Int?
  viewed_at  DateTime @default(now())
  ip_address String?
  user_agent String?
  quotes     quotes   @relation(fields: [quote_id], references: [id], onDelete: Cascade)
  user       user?    @relation(fields: [user_id], references: [id])

  @@index([quote_id])
  @@index([user_id])
}

model quotes {
  id                     Int                      @id @default(autoincrement())
  quote_number           String                   @unique
  revision               Int                      @default(1)
  customer_id            Int?
  contact_id             Int?
  company_id             Int
  project_name           String?
  project_address        String?
  status                 String                   @default("draft")
  subtotal               Decimal                  @default(0) @db.Decimal(10, 2)
  tax_rate               Decimal                  @default(10) @db.Decimal(5, 2)
  tax_amount             Decimal                  @default(0) @db.Decimal(10, 2)
  total                  Decimal                  @default(0) @db.Decimal(10, 2)
  valid_until            DateTime?
  notes                  String?
  internal_notes         String?
  created_by             Int?
  created_at             DateTime                 @default(now())
  updated_at             DateTime
  price_book_id          String?
  calculated_at          DateTime?
  calculated_total       Decimal?                 @db.Decimal(10, 2)
  calculation_breakdown  Json?
  tenant                 companies                @relation(fields: [company_id], references: [id])
  drawings               drawings[]
  quote_drawing_analyses quote_drawing_analyses?
  quote_files            quote_files[]
  quote_rooms            quote_rooms[]
  quote_signatures       quote_signatures?
  quote_views            quote_views[]
  user                   user?                    @relation(fields: [created_by], references: [id])
  customers              customers?               @relation(fields: [customer_id], references: [id])
  contact                customer_contacts?       @relation("QuoteContact", fields: [contact_id], references: [id])
  price_books            price_books?             @relation(fields: [price_book_id], references: [id])
  slab_optimizations     slab_optimizations[]
  unitBlockUnit          unit_block_units?
  buyerChangeSnapshots   buyer_change_snapshots[]
  versions               quote_versions[]
  options                quote_options[]

  // Status lifecycle fields
  status_changed_at DateTime?
  status_changed_by String?
  sent_at           DateTime?
  accepted_at       DateTime?
  declined_at       DateTime?
  declined_reason   String?
  revision_number   Int         @default(1)
  parent_quote_id   Int?
  parent_quote      quotes?     @relation("QuoteRevisions", fields: [parent_quote_id], references: [id])
  child_quotes      quotes[]    @relation("QuoteRevisions")

  // Slab edge allowance (per-quote override, mm)
  slabEdgeAllowanceMm  Int?     @map("slab_edge_allowance_mm")

  // Delivery & templating fields
  deliveryCost         Decimal? @db.Decimal(10, 2)
  templatingCost       Decimal? @db.Decimal(10, 2)
  deliveryAddress      String?
  deliveryDistanceKm   Decimal? @db.Decimal(10, 2)
  templatingRequired   Boolean  @default(false)
  templatingDistanceKm Decimal? @db.Decimal(10, 2)

  // Override fields
  overrideSubtotal       Decimal?  @db.Decimal(10, 2)
  overrideTotal          Decimal?  @db.Decimal(10, 2)
  overrideDeliveryCost   Decimal?  @db.Decimal(10, 2)
  overrideTemplatingCost Decimal?  @db.Decimal(10, 2)
  overrideReason         String?
  overrideBy             Int?
  overrideAt             DateTime?

  @@index([company_id])
}

model quote_versions {
  id                    String   @id @default(cuid())
  quoteId               Int
  version               Int
  snapshotData          Json
  changeType            String
  changeReason          String?
  changeSummary         String?
  changes               Json?
  changedBy             String?
  changedByUserId       Int?
  changedAt             DateTime @default(now())
  rolledBackFromVersion Int?
  subtotal              Decimal? @db.Decimal(10, 2)
  tax_amount            Decimal? @db.Decimal(10, 2)
  totalAmount           Decimal? @db.Decimal(10, 2)
  pieceCount            Int?

  // Relations
  quote         quotes @relation(fields: [quoteId], references: [id], onDelete: Cascade)
  changedByUser user?  @relation(fields: [changedByUserId], references: [id])

  @@unique([quoteId, version])
  @@index([quoteId])
  @@map("quote_versions")
}

model service_rates {
  id                  String              @id
  pricing_settings_id String
  serviceType         ServiceType
  fabricationCategory FabricationCategory @default(ENGINEERED)
  name                String
  description         String?
  rate20mm            Decimal             @db.Decimal(10, 2)
  rate40mm            Decimal             @db.Decimal(10, 2)
  minimumCharge       Decimal?            @db.Decimal(10, 2)
  isActive            Boolean             @default(true)
  created_at          DateTime            @default(now())
  updated_at          DateTime
  pricing_settings    pricing_settings    @relation(fields: [pricing_settings_id], references: [id], onDelete: Cascade)

  @@unique([pricing_settings_id, serviceType, fabricationCategory])
}

model settings {
  id         Int      @id @default(autoincrement())
  key        String   @unique
  value      String
  updated_at DateTime
}

model slab_optimizations {
  id                String   @id
  quoteId           Int?
  slabWidth         Int      @default(3000)
  slabHeight        Int      @default(1400)
  kerfWidth         Int      @default(3)
  totalSlabs        Int
  totalWaste        Decimal  @db.Decimal(10, 2)
  wastePercent      Decimal  @db.Decimal(5, 2)
  placements        Json
  createdAt         DateTime @default(now())
  updatedAt         DateTime
  laminationSummary Json?
  quotes            quotes?  @relation(fields: [quoteId], references: [id], onDelete: Cascade)

  @@index([quoteId])
}

model thickness_options {
  id         String   @id
  name       String   @unique
  value      Int
  multiplier Decimal  @default(1.00) @db.Decimal(5, 2)
  isDefault  Boolean  @default(false)
  isActive   Boolean  @default(true)
  sortOrder  Int      @default(0)
  createdAt  DateTime @default(now())
  updatedAt  DateTime
}

model user_permissions {
  id         Int        @id @default(autoincrement())
  user_id    Int
  permission Permission
  created_at DateTime   @default(now())
  user       user       @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@unique([user_id, permission])
}

model user {
  id                 Int                   @id @default(autoincrement())
  email              String                @unique
  password_hash      String
  name               String?
  created_at         DateTime              @default(now())
  updated_at         DateTime
  customer_id        Int?
  invited_at         DateTime?
  invited_by         Int?
  is_active          Boolean               @default(true)
  last_active_at     DateTime?
  last_login_at      DateTime?
  role               UserRole              @default(SALES_REP)
  customer_user_role CustomerUserRole?
  company_id         Int?
  audit_logs         audit_logs[]
  quote_signatures   quote_signatures[]
  quote_views        quote_views[]
  quotes             quotes[]
  user_permissions   user_permissions[]
  companies          companies?            @relation(fields: [company_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  customers          customers?            @relation(fields: [customer_id], references: [id])
  unitBlockProjects  unit_block_projects[]
  quote_versions     quote_versions[]
  contact_portal     customer_contacts?   @relation("ContactPortalUser")

  @@map("users")
}

model suppliers {
  id                       String              @id @default(cuid())
  company_id               Int
  company                  companies           @relation(fields: [company_id], references: [id])
  name                     String

  contact_email            String?
  phone                    String?
  website                  String?

  // Default margin applied to all materials from this supplier
  default_margin_percent   Decimal?            @default(0) @db.Decimal(5, 2)

  // Default slab dimensions for this supplier's products
  default_slab_length_mm   Int?
  default_slab_width_mm    Int?
  default_thickness_mm     Int?

  notes                    String?
  is_active                Boolean             @default(true)
  created_at               DateTime            @default(now())
  updated_at               DateTime            @updatedAt

  materials                materials[]
  price_list_uploads       price_list_uploads[]

  @@unique([company_id, name])
  @@index([company_id])
}

model price_list_uploads {
  id                    String          @id @default(cuid())
  supplier_id           String
  supplier              suppliers       @relation(fields: [supplier_id], references: [id])
  company_id            Int

  file_name             String
  file_url              String
  uploaded_at           DateTime        @default(now())

  // AI extraction results
  extracted_data        Json?
  status                PriceListStatus @default(PENDING)

  // Stats
  materials_created     Int             @default(0)
  materials_updated     Int             @default(0)
  materials_discontinued Int            @default(0)
  materials_skipped     Int             @default(0)

  // Audit
  processed_at          DateTime?
  error_message         String?

  @@index([supplier_id])
  @@index([company_id])
}

enum PriceListStatus {
  PENDING
  PROCESSING
  REVIEW
  APPLIED
  FAILED
}

enum CustomerUserRole {
  CUSTOMER_ADMIN
  CUSTOMER_APPROVER
  CUSTOMER_VIEWER
  CUSTOM
}

enum CutoutRateCategory {
  HOTPLATE
  GPO
  TAP_HOLE
  DROP_IN_SINK
  UNDERMOUNT_SINK
  FLUSH_COOKTOP
  BASIN
  DRAINER_GROOVES
  OTHER
}

enum MaterialPricingBasis {
  PER_SLAB
  PER_SQUARE_METRE
}

enum WaterfallPricingMethod {
  FIXED_PER_END
  PER_LINEAR_METRE
  INCLUDED_IN_SLAB
}

enum Permission {
  MANAGE_USERS
  VIEW_USERS
  MANAGE_CUSTOMERS
  VIEW_CUSTOMERS
  CREATE_QUOTES
  EDIT_QUOTES
  DELETE_QUOTES
  VIEW_ALL_QUOTES
  VIEW_OWN_QUOTES
  APPROVE_QUOTES
  MANAGE_MATERIALS
  VIEW_MATERIALS
  MANAGE_PRICING
  VIEW_PRICING
  RUN_OPTIMIZATION
  VIEW_OPTIMIZATION
  EXPORT_CUTLISTS
  VIEW_REPORTS
  EXPORT_DATA
  MANAGE_SETTINGS
  VIEW_AUDIT_LOGS
  UPLOAD_FILES
  MANAGE_CUSTOMER_USERS
  DOWNLOAD_QUOTES
  VIEW_PROJECT_UPDATES
}

enum RateUnit {
  LINEAR_METER
  SQUARE_METER
  FIXED
  PER_KM
}

enum ServiceType {
  CUTTING
  POLISHING
  INSTALLATION
  WATERFALL_END
  TEMPLATING
  DELIVERY
  JOIN
}

enum ServiceUnit {
  LINEAR_METRE
  SQUARE_METRE
  FIXED
  PER_SLAB
  PER_KILOMETRE
}

enum UnitSystem {
  METRIC
  IMPERIAL
}

enum FabricationCategory {
  ENGINEERED
  NATURAL_HARD
  NATURAL_SOFT
  NATURAL_PREMIUM
  SINTERED
}

enum LaminationMethod {
  NONE
  LAMINATED
  MITRED
}

enum OperationType {
  INITIAL_CUT
  EDGE_POLISHING
  MITRING
  LAMINATION
  CUTOUT
}

enum UserRole {
  ADMIN
  SALES_MANAGER
  SALES_REP
  FABRICATOR
  READ_ONLY
  CUSTOM
  CUSTOMER
}

enum ContactRole {
  PRIMARY
  SITE_SUPERVISOR
  ACCOUNTS
  PROJECT_MANAGER
  OTHER
}

enum QuoteStatus {
  DRAFT
  REVIEW
  SENT
  ACCEPTED
  DECLINED
  REVISION
  IN_PRODUCTION
  COMPLETED
  ARCHIVED
}

enum RelationshipType {
  WATERFALL
  SPLASHBACK
  RETURN
  WINDOW_SILL
  MITRE_JOIN
  BUTT_JOIN
}

enum UnitBlockProjectType {
  APARTMENTS
  TOWNHOUSES
  COMMERCIAL
  MIXED_USE
  OTHER
}

enum ProjectStatus {
  DRAFT
  QUOTING
  QUOTED
  SUBMITTED
  APPROVED
  IN_PRODUCTION
  COMPLETED
  CANCELLED
}

enum UnitStatus {
  PENDING
  QUOTED
  BUYER_CHANGE
  UPGRADE
  APPROVED
  SOLD
  ON_HOLD
}

model edge_profile_templates {
  id                 String   @id @default(cuid())
  companyId          Int      @map("company_id")
  name               String
  description        String?

  // Edge assignments (edge type IDs)
  edgeTop            String?  @map("edge_top")
  edgeBottom         String?  @map("edge_bottom")
  edgeLeft           String?  @map("edge_left")
  edgeRight          String?  @map("edge_right")

  // Scope
  isBuiltIn          Boolean  @default(false) @map("is_built_in")
  isShared           Boolean  @default(true)  @map("is_shared")
  createdById        Int?     @map("created_by_id")

  // Piece type hint
  suggestedPieceType String?  @map("suggested_piece_type")

  createdAt          DateTime @default(now()) @map("created_at")
  updatedAt          DateTime @updatedAt      @map("updated_at")

  @@map("edge_profile_templates")
}

model starter_templates {
  id           String   @id @default(cuid())
  companyId    Int      @map("company_id")
  name         String
  description  String?
  category     String   // kitchen, bathroom, laundry, multi-room
  isBuiltIn    Boolean  @default(false) @map("is_built_in")
  isShared     Boolean  @default(true)  @map("is_shared")
  templateData Json     @map("template_data") // Full room/piece/edge/cutout structure
  createdById  Int?     @map("created_by_id")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt      @map("updated_at")

  @@unique([companyId, name])
  @@map("starter_templates")
}

model unit_block_projects {
  id          Int                  @id @default(autoincrement())
  name        String
  projectType UnitBlockProjectType @default(APARTMENTS)
  status      ProjectStatus        @default(DRAFT)

  // Tenant isolation
  company_id Int
  tenant     companies @relation(fields: [company_id], references: [id])

  // Client
  customerId Int?
  customer   customers? @relation(fields: [customerId], references: [id])

  // Address
  address  String?
  suburb   String?
  state    String?
  postcode String?

  // Project metadata
  totalUnits  Int     @default(0)
  totalLevels Int?
  description String?
  notes       String?

  // Volume pricing
  volumeTier     String?
  volumeDiscount Decimal? @default(0) @db.Decimal(10, 2)
  totalArea_sqm  Decimal? @default(0) @db.Decimal(10, 4)

  // Financials (calculated)
  subtotalExGst  Decimal? @default(0) @db.Decimal(10, 2)
  discountAmount Decimal? @default(0) @db.Decimal(10, 2)
  gstAmount      Decimal? @default(0) @db.Decimal(10, 2)
  grandTotal     Decimal? @default(0) @db.Decimal(10, 2)

  // Files
  finishesRegisterId Int?

  // Ownership
  createdById Int?
  createdBy   user? @relation(fields: [createdById], references: [id])

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  units     unit_block_units[]
  files     unit_block_files[]
  templates unit_type_templates[]

  @@index([company_id])
  @@map("unit_block_projects")
}

model unit_block_units {
  id Int @id @default(autoincrement())

  // Parent project
  projectId Int
  project   unit_block_projects @relation(fields: [projectId], references: [id], onDelete: Cascade)

  // Unit identification
  unitNumber String
  level      Int?

  // Unit type and finish
  unitTypeCode String?
  finishLevel  String?
  colourScheme String?

  // Status
  status          UnitStatus @default(PENDING)
  saleStatus      String?
  buyerChangeSpec Boolean    @default(false)

  // Linked quote
  quoteId Int?    @unique
  quote   quotes? @relation(fields: [quoteId], references: [id])

  // Template reference (for regeneration)
  templateId Int?
  template   unit_type_templates? @relation(fields: [templateId], references: [id])

  // Override notes
  notes String?

  // Buyer change tracking (legacy JSON fields kept for backwards compatibility)
  originalQuoteSnapshot Json?
  lastChangeAt          DateTime?
  changeNotes           String?
  costDelta             Decimal?  @default(0) @db.Decimal(10, 2)
  changeHistory         Json?

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations to buyer change tracking tables
  buyerChangeSnapshots buyer_change_snapshots[]
  buyerChangeRecords   buyer_change_records[]

  @@unique([projectId, unitNumber])
  @@map("unit_block_units")
}

model unit_type_templates {
  id Int @id @default(autoincrement())

  // Identity
  name         String // e.g. "Type A — Kitchen & Wet Areas"
  unitTypeCode String // e.g. "A" — matches FR.01 unit type column
  description  String?

  // Source tracking
  projectId       Int? // optionally tied to a specific project
  project         unit_block_projects? @relation(fields: [projectId], references: [id])
  sourceDrawingId Int? // which drawing was this extracted from

  // Template data — JSON blob containing rooms, pieces, edges, cutouts
  templateData Json // TemplateData type

  // Metadata
  version  Int     @default(1)
  isActive Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  units          unit_block_units[]
  finishMappings finish_tier_mappings[]

  @@unique([unitTypeCode, projectId])
  @@map("unit_type_templates")
}

model finish_tier_mappings {
  id Int @id @default(autoincrement())

  // Links
  templateId Int
  template   unit_type_templates @relation(fields: [templateId], references: [id], onDelete: Cascade)

  // Finish tier identity
  finishLevel  String // "PREMIUM", "DELUXE", "PENTHOUSE_SERIES"
  colourScheme String? // "LINEN", "SILK", "DENIM" — optional further refinement

  // Material assignments — JSON mapping materialRole → materialId
  materialAssignments Json // { "PRIMARY_BENCHTOP": 42, "VANITY": 15, "LAUNDRY": 15 }

  // Edge overrides — if Premium uses mitred and Deluxe uses arris
  edgeOverrides Json? // { "PRIMARY_BENCHTOP": { "edges": { "top": { "finish": "MITRED" } } } }

  // Metadata
  description String?
  isActive    Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([templateId, finishLevel, colourScheme])
  @@map("finish_tier_mappings")
}

model buyer_change_snapshots {
  id Int @id @default(autoincrement())

  // Links
  unitId  Int
  unit    unit_block_units @relation(fields: [unitId], references: [id], onDelete: Cascade)
  quoteId Int
  quote   quotes           @relation(fields: [quoteId], references: [id], onDelete: Cascade)

  // Snapshot data
  snapshotData Json // Full quote state at time of snapshot
  snapshotType String // "STANDARD" or "BUYER_CHANGE"

  createdAt DateTime @default(now())

  @@index([unitId])
  @@index([quoteId])
  @@map("buyer_change_snapshots")
}

model buyer_change_records {
  id Int @id @default(autoincrement())

  // Links
  unitId Int
  unit   unit_block_units @relation(fields: [unitId], references: [id], onDelete: Cascade)

  // Change details
  changeType    String // MATERIAL_UPGRADE, EDGE_CHANGE, CUTOUT_ADD, CUTOUT_REMOVE, DIMENSION_CHANGE, PIECE_ADD, PIECE_REMOVE
  description   String // Human-readable description
  pieceName     String? // Which piece was affected
  roomName      String? // Which room
  previousValue String? // What it was before
  newValue      String? // What it is now
  costDelta     Decimal @default(0) @db.Decimal(10, 2)

  createdAt DateTime @default(now())
  createdBy String? // User who made the change

  @@index([unitId])
  @@map("buyer_change_records")
}

model quote_options {
  id             Int       @id @default(autoincrement())
  quoteId        Int
  quote          quotes    @relation(fields: [quoteId], references: [id], onDelete: Cascade)
  name           String
  description    String?
  sortOrder      Int       @default(0)
  isBase         Boolean   @default(false)

  // Cached pricing totals (recalculated when pieces/overrides change)
  subtotal       Decimal?  @db.Decimal(10, 2)
  discountAmount Decimal?  @db.Decimal(10, 2)
  gstAmount      Decimal?  @db.Decimal(10, 2)
  total          Decimal?  @db.Decimal(10, 2)

  // Per-quote material margin +/- adjustment
  material_margin_adjust_percent Decimal? @default(0) @db.Decimal(5, 2)

  overrides      quote_option_overrides[]

  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  @@index([quoteId])
  @@map("quote_options")
}

model quote_option_overrides {
  id              Int             @id @default(autoincrement())
  optionId        Int
  option          quote_options   @relation(fields: [optionId], references: [id], onDelete: Cascade)
  pieceId         Int

  // ALL override fields are nullable — null means "use base piece value"
  materialId      Int?
  thicknessMm     Int?
  edgeTop         String?
  edgeBottom      String?
  edgeLeft        String?
  edgeRight       String?
  cutouts         Json?
  lengthMm        Int?
  widthMm         Int?

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@unique([optionId, pieceId])
  @@index([optionId])
  @@map("quote_option_overrides")
}

model unit_block_files {
  id        Int                 @id @default(autoincrement())
  projectId Int
  project   unit_block_projects @relation(fields: [projectId], references: [id], onDelete: Cascade)

  // File info
  fileName   String
  fileType   String
  storageKey String
  mimeType   String?
  fileSize   Int?

  // Metadata
  unitTypeCode String?
  description  String?

  createdAt DateTime @default(now())

  @@map("unit_block_files")
}

model custom_room_presets {
  id           String   @id @default(uuid())
  company_id   Int
  name         String
  icon         String?
  description  String?
  piece_config Json
  usage_count  Int      @default(1)
  last_used_at DateTime @default(now())
  created_at   DateTime @default(now())
  updated_at   DateTime @updatedAt

  tenant companies @relation(fields: [company_id], references: [id])

  @@index([company_id, usage_count(sort: Desc)])
  @@index([company_id, name])
}

model quote_templates {
  id              String   @id @default(uuid())
  company_id      Int
  name            String
  description     String?
  format_type     String   @default("COMPREHENSIVE") // COMPREHENSIVE | SUMMARY
  is_default      Boolean  @default(false)
  is_active       Boolean  @default(true)

  // Section toggles — JSON object (QuoteTemplateSections interface)
  sections_config Json     @default("{}")

  // Header
  company_name    String?
  company_abn     String?
  company_phone   String?
  company_email   String?
  company_address String?
  logo_url        String?
  show_logo       Boolean  @default(true)

  // Display settings
  show_piece_breakdown    Boolean @default(true)
  show_edge_details       Boolean @default(true)
  show_cutout_details     Boolean @default(true)
  show_material_per_piece Boolean @default(false)
  show_room_totals        Boolean @default(true)
  show_itemised_breakdown Boolean @default(false)
  show_slab_count         Boolean @default(false)
  show_piece_descriptions Boolean @default(true)

  // Pricing display
  pricing_mode    String   @default("room_total")
  show_gst        Boolean  @default(true)
  gst_label       String   @default("GST (10%)")
  currency_symbol String   @default("$")

  // Custom text overrides (null = use company defaults)
  custom_intro_text    String?  @db.Text
  terms_and_conditions String?  @db.Text
  footer_text          String?

  // Styling overrides (null = use company defaults)
  custom_primary_colour String?
  custom_accent_colour  String?

  // Other overrides
  validity_days         Int       @default(30)

  created_at    DateTime @default(now())
  updated_at    DateTime @updatedAt

  company       companies  @relation(fields: [company_id], references: [id])

  @@index([company_id])
}

model piece_relationships {
  id             Int          @id @default(autoincrement())

  // The 'parent' piece (typically the main benchtop)
  source_piece_id Int
  sourcePiece     quote_pieces @relation("source_relationships", fields: [source_piece_id], references: [id], onDelete: Cascade)

  // The 'child' piece (waterfall, splashback, etc.)
  target_piece_id Int
  targetPiece     quote_pieces @relation("target_relationships", fields: [target_piece_id], references: [id], onDelete: Cascade)

  // Relationship type: WATERFALL, SPLASHBACK, RETURN_END, MITRE_JOIN, BUTT_JOIN, etc.
  relation_type   String

  // Typed enum version of relation_type (nullable during migration)
  relationship_type RelationshipType?

  // Which side of the source piece (top, bottom, left, right)
  side            String?

  // Optional notes about the relationship
  notes           String?

  created_at      DateTime @default(now())
  updated_at      DateTime @updatedAt @default(now())

  @@unique([source_piece_id, target_piece_id])
}
